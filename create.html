<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LEGO RPG Manager - Crea</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --lego-yellow: #f7d23e;
      --lego-red: #e53e3e;
      --lego-blue: #3182ce;
      --lego-gray: #f8f8f8;
    }

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: var(--lego-gray);
      color: #222;
    }

    header {
      background: var(--lego-yellow);
      padding: 20px;
      text-align: center;
      font-weight: 800;
      font-size: 1.8em;
      color: var(--lego-red);
      text-shadow: 2px 2px 0 #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      position: relative;
    }

    .logout, .back {
      position: absolute;
      top: 20px;
      background: var(--lego-red);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }

    .back {
      left: 30px;
      background: var(--lego-blue);
    }

    .logout {
      right: 30px;
    }

    .logout:hover { background: #ff5252; }
    .back:hover { background: #4a9aff; }

    main {
      max-width: 1000px;
      margin: 40px auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: var(--lego-blue);
      font-size: 1.8em;
      margin-bottom: 30px;
    }

    .create-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card-btn {
      background: white;
      border-radius: 20px;
      padding: 30px 20px;
      text-align: center;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      border-top: 8px solid var(--lego-yellow);
      transition: 0.3s;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1em;
      color: var(--lego-blue);
    }

    .card-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .form-section {
      margin-top: 40px;
      display: none;
    }

    .form-section.active { display: block; }
    h2 { color: var(--lego-red); }

    label {
      display: block;
      font-weight: 600;
      margin: 10px 0 5px;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-family: inherit;
      margin-bottom: 15px;
    }

    button {
      background: var(--lego-blue);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
      margin-right: 10px;
    }

    button:hover { background: #4a9aff; }

    #preview {
      margin-top: 50px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9em;
    }

    th {
      background: var(--lego-yellow);
      color: #333;
    }

    footer {
      text-align: center;
      padding: 20px;
      font-size: 0.9em;
      color: #777;
    }
  </style>
</head>
<body>
  <header>
    LEGO RPG Manager - Crea
    <button class="back" onclick="goBack()">‚Üê Dashboard</button>
    <button class="logout" onclick="logout()">Logout</button>
  </header>

  <main>
    <h1>Seleziona cosa vuoi creare</h1>

    <div class="create-grid">
      <div class="card-btn" onclick="showForm('bioma')">üèû Bioma</div>
      <div class="card-btn" onclick="showForm('eff')">‚öóÔ∏è Effetto / Stato</div>
    </div>

    <div id="form-bioma" class="form-section">
      <h2>üèû Crea Nuovo Bioma</h2>
      <label>Nome Bioma*</label><input id="nome-bioma" type="text" required>
      <label>Difficolt√† di movimento (1-10)*</label><input id="diff-bioma" type="number" min="1" max="10" required>
      <label>Effetto</label>
      <select id="effetto-bioma">
        <option value="">‚Äî Nessun effetto ‚Äî</option>
      </select>
      <label>Probabilit√† effetto (%)</label><input id="prob-bioma" type="number" min="0" max="100" placeholder="0-100">
      <label>Descrizione*</label><textarea id="desc-bioma" rows="3" required></textarea>
      <button onclick="caricaCSV('bioma')">üìÇ Carica CSV</button>
      <button onclick="aggiungiRiga('bioma')">‚ûï Aggiungi Bioma</button>
      <button onclick="scaricaCSV('bioma')">üíæ Scarica CSV</button>
    </div>

    <div id="form-eff" class="form-section">
      <h2>‚öóÔ∏è Crea Nuovo Effetto / Stato</h2>
      <label>Nome Effetto*</label><input id="nome-eff" type="text" required>
      <label>Descrizione*</label><textarea id="desc-eff" rows="3" required></textarea>
      <button onclick="caricaCSV('eff')">üìÇ Carica CSV</button>
      <button onclick="aggiungiRiga('eff')">‚ûï Aggiungi Effetto</button>
      <button onclick="scaricaCSV('eff')">üíæ Scarica CSV</button>
    </div>

    <div id="preview">
      <h3>üìã Anteprima CSV</h3>
      <div id="table-container"></div>
    </div>
  </main>

  <footer>Creato da MEX ¬∑ Versione prototipo</footer>

  <script>
    const data = { bioma: [], eff: [] };

    function logout() {
      localStorage.removeItem("legoUser");
      window.location.href = "index.html";
    }
    function goBack() { window.location.href = "dashboard.html"; }

    function showForm(type) {
      document.querySelectorAll(".form-section").forEach(s => s.classList.remove("active"));
      document.getElementById("form-" + type).classList.add("active");
      if (type === "bioma") caricaEffettiDaGitHub();
    }

    async function caricaEffettiDaGitHub() {
      try {
        const response = await fetch("https://raw.githubusercontent.com/<mtmexx>/<REPO>/main/db/effetti-stati.csv");
        const text = await response.text();
        const lines = text.split("\n").slice(1).filter(l => l.trim() !== "");
        const effetti = lines.map(l => l.split(";")[1]);
        const select = document.getElementById("effetto-bioma");
        select.innerHTML = '<option value="">‚Äî Nessun effetto ‚Äî</option>';
        effetti.forEach(e => {
          const opt = document.createElement("option");
          opt.value = e;
          opt.textContent = e;
          select.appendChild(opt);
        });
      } catch (err) {
        console.warn("Impossibile caricare effetti da GitHub:", err);
      }
    }

    function caricaCSV(tipo) {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".csv";
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = () => {
          const lines = reader.result.split("\n").filter(l => l.trim() !== "");
          data[tipo] = lines.slice(1).map(l => l.split(";"));
          mostraPreview(tipo);
          alert("CSV caricato con successo!");
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function aggiungiRiga(tipo) {
      if (tipo === "bioma") {
        const nome = document.getElementById("nome-bioma").value.trim();
        const diff = document.getElementById("diff-bioma").value.trim();
        const eff = document.getElementById("effetto-bioma").value.trim();
        const prob = document.getElementById("prob-bioma").value.trim() || "0";
        const desc = document.getElementById("desc-bioma").value.trim();
        if (!nome || !diff || !desc) return alert("Compila tutti i campi obbligatori!");
        const id = data.bioma.length + 1;
        data.bioma.push([id, nome, diff, eff, prob, desc]);
        mostraPreview("bioma");
        alert("Bioma aggiunto!");
      }
      if (tipo === "eff") {
        const nome = document.getElementById("nome-eff").value.trim();
        const desc = document.getElementById("desc-eff").value.trim();
        if (!nome || !desc) return alert("Compila tutti i campi obbligatori!");
        const id = data.eff.length + 1;
        data.eff.push([id, nome, desc]);
        mostraPreview("eff");
        alert("Effetto aggiunto!");
      }
    }

    function scaricaCSV(tipo) {
      let csv = "";
      if (tipo === "bioma") {
        csv = "id;nome;difficolta;effetto;probabilita;descrizione\n" +
          data.bioma.map(r => r.join(";")).join("\n");
      } else {
        csv = "id;nome;descrizione\n" +
          data.eff.map(r => r.join(";")).join("\n");
      }
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = tipo === "bioma" ? "biomi.csv" : "effetti-stati.csv";
      link.click();
    }

    function mostraPreview(tipo) {
      const container = document.getElementById("table-container");
      const rows = data[tipo];
      if (!rows || rows.length === 0) {
        container.innerHTML = "<p>Nessun dato da mostrare</p>";
        return;
      }
      let headers = tipo === "bioma"
        ? ["ID", "Nome", "Difficolt√†", "Effetto", "Prob%", "Descrizione"]
        : ["ID", "Nome", "Descrizione"];
      let html = "<table><tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";
      rows.forEach(r => {
        html += "<tr>" + r.map(c => `<td>${c}</td>`).join("") + "</tr>";
      });
      html += "</table>";
      container.innerHTML = html;
    }
  </script>
</body>
</html>
