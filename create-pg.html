<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LEGO RPG Manager - Crea Personaggio</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --lego-yellow:#f7d23e; --lego-red:#e53e3e; --lego-blue:#3182ce; --lego-gray:#f8f8f8;
}
*{box-sizing:border-box}
body{margin:0;font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--lego-gray);color:#222}
header{background:var(--lego-yellow);padding:14px 18px;color:var(--lego-red);font-weight:800;text-align:center;position:relative;box-shadow:0 3px 10px rgba(0,0,0,.12)}
.header-btn{position:absolute;top:12px;padding:8px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
#backBtn{left:14px;background:var(--lego-blue);color:#fff}
#logoutBtn{right:14px;background:var(--lego-red);color:#fff}
main{max-width:1100px;margin:26px auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
h1{color:var(--lego-blue);margin:0 0 10px;font-size:1.4rem}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.form-row.single{grid-template-columns:1fr}
label{display:block;font-weight:700;margin-bottom:6px}
select,input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #dcdcdc}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:14px}
.stat-item{background:#fafafa;border-radius:10px;padding:10px;border-top:6px solid var(--lego-yellow)}
.stat-item .row{display:flex;justify-content:space-between;align-items:center}
.small{font-size:.9rem;color:#444}
.preview{margin-top:18px;padding:14px;border-radius:10px;background:#f2f7ff;border-left:8px solid var(--lego-blue)}
.mod-table, .pg-table{width:100%;border-collapse:collapse;margin-top:12px}
.mod-table th,.mod-table td,.pg-table th,.pg-table td{border:1px solid #e6e6e6;padding:8px;text-align:center}
.mod-table th,.pg-table th{background:var(--lego-yellow)}
.btn{background:var(--lego-blue);color:#fff;padding:10px 14px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
.btn.red{background:var(--lego-red)}
.footer{display:flex;gap:10px;justify-content:center;margin-top:18px}
.note{font-size:.85rem;color:#666;margin-top:8px}
@media (max-width:720px){ .form-row{grid-template-columns:1fr} header{font-size:1rem} }
</style>
</head>
<body>
<header>
  Crea Personaggio
  <button id="backBtn" class="header-btn" onclick="location.href='dashboard.html'">← Dashboard</button>
  <button id="logoutBtn" class="header-btn" onclick="logout()">Logout</button>
</header>

<main>
  <h1>Generatore Personaggio — Crea & Test</h1>

  <div class="form-row single">
    <div>
      <label for="name">Nome</label>
      <input id="name" type="text" placeholder="Nome personaggio">
    </div>
  </div>

  <div class="form-row">
    <div>
      <label for="sel-specie">Specie</label>
      <select id="sel-specie"></select>
    </div>
    <div>
      <label for="sel-classe">Classe</label>
      <select id="sel-classe"></select>
    </div>
  </div>

  <div class="form-row">
    <div>
      <label for="sel-multi">Multiverso</label>
      <select id="sel-multi"></select>
    </div>
    <div>
      <label for="sel-liv">Livello</label>
      <select id="sel-liv"></select>
    </div>
  </div>

  <div class="form-row">
    <div>
      <label for="sel-grado">Grado</label>
      <select id="sel-grado"></select>
    </div>
    <div>
      <label>Punti disponibili</label>
      <div class="small" id="punti-info">0 usati / 0 disponibili</div>
    </div>
  </div>

  <p class="note">Distribuisci i punti alle statistiche primarie. I modificatori si aggiornano in tempo reale (base + specie + classe).</p>

  <div class="stat-grid" id="stat-grid">
    <!-- stats injected here -->
  </div>

  <h3 style="margin-top:16px">Modificatori</h3>
  <table class="mod-table" id="mod-table">
    <thead><tr><th>Stat</th><th>Mod Totale</th></tr></thead>
    <tbody></tbody>
  </table>

  <div class="preview-card">
    <div class="preview-title">Anteprima Personaggio</div>
    <div id="preview"></div>
  </div>

  <div class="footer">
    <button class="btn" onclick="aggiungiPG()">Aggiungi PG (in lista)</button>
    <button class="btn" onclick="scaricaCSV()">Scarica pg-database.csv</button>
    <button class="btn red" onclick="resetNuovi()">Reset nuovi</button>
  </div>

  <h3 style="margin-top:18px">Tabella PG (esistenti + nuovi)</h3>
  <table class="pg-table" id="pg-table"><thead></thead><tbody></tbody></table>
</main>

<script>
/* ------------- CONFIG ------------- */
const BASE = "https://raw.githubusercontent.com/MTMEXX/lego-rpg-manager/refs/heads/main/db/";
const FILES = {
  speci: "speci.csv",
  classi: "classi.csv",
  multiversi: "multiversi-pg.csv",
  livelli: "livelli.csv",
  gradi: "gradi.csv",
  stats: "statistiche_primarie.csv",
  pgdb: "pg-database.csv"
};

/* ------------- STATE ------------- */
let RAW = {};
let SPECIE = [], CLASSI = [], MULTI = [], LIVELLI = [], GRADI = [], STATS = [], PGDB = [];
let NUOVI = []; // new created rows arrays
let statNames = [];
let puntiDisponibili = 0;
let puntiUsati = 0;

/* ------------- CSV PARSER ; safe for quotes ------------- */
function splitSemicolonSafe(line){
  let res=[]; let cur=""; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){ inQ=!inQ; continue; }
    if(!inQ && ch === ';'){ res.push(cur); cur=""; } else cur+=ch;
  }
  res.push(cur);
  return res.map(s=>s.trim());
}
function parseCSV(text){
  return text.replace(/\r/g,"").split("\n").filter(l=>l.trim()!=="").map(l=>splitSemicolonSafe(l));
}

/* ------------- LOAD ALL CSV ------------- */
async function fetchCSV(path){
  try {
    const r = await fetch(path);
    if(!r.ok) return null;
    const t = await r.text();
    return parseCSV(t);
  } catch(e){ console.error("fetch",e); return null; }
}

async function init(){
  RAW.speci = await fetchCSV(BASE + FILES.speci) || [];
  RAW.classi = await fetchCSV(BASE + FILES.classi) || [];
  RAW.multiversi = await fetchCSV(BASE + FILES.multiversi) || [];
  RAW.livelli = await fetchCSV(BASE + FILES.livelli) || [];
  RAW.gradi = await fetchCSV(BASE + FILES.gradi) || [];
  RAW.stats = await fetchCSV(BASE + FILES.stats) || [];
  RAW.pgdb = await fetchCSV(BASE + FILES.pgdb) || [];

  // strip headers when present (detect header by presence of "nome" in first row)
  function stripHeader(arr){
    if(!arr || arr.length===0) return [];
    const first = arr[0].map(c=> (c||"").toString().toLowerCase());
    if(first.some(x=>x.includes("nome")||x.includes("id"))) return arr.slice(1);
    return arr;
  }

  SPECIE = stripHeader(RAW.speci);
  CLASSI = stripHeader(RAW.classi);
  MULTI = stripHeader(RAW.multiversi);
  LIVELLI = stripHeader(RAW.livelli);
  GRADI = stripHeader(RAW.gradi);
  STATS = stripHeader(RAW.stats);
  PGDB = stripHeader(RAW.pgdb);

  statNames = STATS.map(r => r[1] || r[0]);

  buildSelect("sel-specie", SPECIE);
  buildSelect("sel-classe", CLASSI);
  buildSelect("sel-multi", MULTI);
  buildSelect("sel-liv", LIVELLI);
  buildSelect("sel-grado", GRADI);

  renderStatInputs();
  buildPGTable();
  attachLiveEvents();
  recalcAll(); // initial
}

/* ------------- UI BUILDERS ------------- */
function buildSelect(id, rows){
  const sel = document.getElementById(id);
  sel.innerHTML = "<option value=''>-- Seleziona --</option>";
  rows.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r[0] || "";
    opt.textContent = r[1] || r[0] || "";
    sel.appendChild(opt);
  });
  sel.addEventListener("change", () => { onGradeChangeIfNeeded(); recalcAll(); updatePreview(); });
}

function renderStatInputs(){
  const container = document.getElementById("stat-grid");
  container.innerHTML = "";
  statNames.forEach((name, idx)=>{
    const card = document.createElement("div");
    card.className = "stat-item";
    card.innerHTML = `
      <div style="font-weight:700">${name}</div>
      <div class="row" style="margin-top:8px">
        <div class="small">Valore</div>
        <input data-idx="${idx}" type="number" min="0" value="8" style="width:72px;padding:8px;border-radius:6px;border:1px solid #ccc">
      </div>
      <div class="row" style="margin-top:6px">
        <div class="small">Base mod</div>
        <div id="base-${idx}">-1</div>
      </div>
    `;
    container.appendChild(card);
  });
  // ensure event listeners
  document.querySelectorAll("#stat-grid input").forEach(inp=>{
    inp.addEventListener("change", onStatInputChange);
  });
}

/* ------------- HELPERS: find modifier arrays ------------- */
/*
  From your headers:
  SPECIE columns: ID;NOME;Mod_PV_Base;Mod_PE_Base;Mod_PS_Base;Mod _for;Mod_des;Mod_cos;Mod_int;Mod_sag;Mod_car
  CLASSI columns: ID;NOME;...; Mod_for (col K);Mod_des;Mod_cos;Mod_int;Mod_sag;Mod_car (K..P)
  We'll read using index positions but try to be robust:
*/
function getSpecieModsByRow(row){
  // try to read indexes 5..10, fallback to zeros
  const mods = [];
  for(let i=5;i<=10;i++){
    mods.push(Number(row[i] || 0));
  }
  return mods;
}
function getClasseModsByRow(row){
  // try indexes 10..15
  const mods=[];
  for(let i=10;i<=15;i++){
    mods.push(Number(row[i] || 0));
  }
  return mods;
}

/* ------------- EVENTS & CALCS ------------- */
function onStatInputChange(e){
  const inp = e.target;
  const idx = Number(inp.dataset.idx);
  let val = Number(inp.value) || 0;
  if(val < 0) val = 0;
  // compute used points and enforce limit
  const all = Array.from(document.querySelectorAll("#stat-grid input")).map(i => Number(i.value) || 0);
  const used = all.reduce((s,v)=>s+v,0);
  // get available points from selected grado
  const available = Number(puntiDisponibili) || 0;
  // If used > available, revert this change (or clamp)
  if(used > available){
    // clamp this input so total <= available
    const prevTotalExcl = used - val;
    const allowed = Math.max(0, available - prevTotalExcl);
    inp.value = allowed;
  }
  // update base mods display and recalc
  updateBaseModDisplays();
  recalcAll();
  updatePreview();
}

function onGradeChangeIfNeeded(){
  // when grado changes, update puntiDisponibili and reset stat values to 0
  const gsel = document.getElementById("sel-grado");
  const gid = gsel.value;
  let bp = 0;
  if(GRADI.length){
    const found = GRADI.find(r => r[0] == gid);
    if(found) bp = Number(found[3] || 0); // per header it's column D (index 3)
  }
  puntiDisponibili = bp;
  // Set stat inputs to 0 when grade changes (safe)
  document.querySelectorAll("#stat-grid input").forEach(i => i.value = 0);
  document.getElementById("punti-info").textContent = `0 usati / ${puntiDisponibili} disponibili`;
}

/* ------------- recalc modifiers and UI ------------- */
function updateBaseModDisplays(){
  document.querySelectorAll("#stat-grid input").forEach(inp=>{
    const idx = Number(inp.dataset.idx);
    const v = Number(inp.value) || 0;
    const base = Math.floor((v - 10)/2);
    const el = document.getElementById("base-" + idx);
    if(el) el.textContent = (base >= 0 ? "+"+base : base);
  });
}

function recalcAll(){
  // recalc used/available
  const vals = Array.from(document.querySelectorAll("#stat-grid input")).map(i=>Number(i.value)||0);
  const used = vals.reduce((s,v)=>s+v,0);
  document.getElementById("punti-info").textContent = `${used} usati / ${puntiDisponibili} disponibili`;
  // specie/class mods
  const specieId = document.getElementById("sel-specie").value;
  const classeId = document.getElementById("sel-classe").value;
  const specieRow = SPECIE.find(r=>r[0]==specieId) || [];
  const classeRow = CLASSI.find(r=>r[0]==classeId) || [];
  const sMods = getSpecieModsByRow(specieRow);
  const cMods = getClasseModsByRow(classeRow);
  // build mod table
  const tbody = document.querySelector("#mod-table tbody");
  tbody.innerHTML = "";
  statNames.forEach((sName, idx)=>{
    const val = vals[idx] || 0;
    const base = Math.floor((val - 10)/2);
    const total = base + (Number(sMods[idx]||0)) + (Number(cMods[idx]||0));
    const display = (total>=0? "+"+total : total);
    tbody.innerHTML += `<tr><td>${sName}</td><td>${display}</td></tr>`;
  });
  updatePreview();
}

/* ------------- preview ------------- */
function updatePreview(){
  const name = document.getElementById("name").value || "Personaggio senza nome";
  const specieText = (document.getElementById("sel-specie").selectedOptions[0] || {}).textContent || "-";
  const classeText = (document.getElementById("sel-classe").selectedOptions[0] || {}).textContent || "-";
  const multiText = (document.getElementById("sel-multi").selectedOptions[0] || {}).textContent || "-";
  const livText = (document.getElementById("sel-liv").selectedOptions[0] || {}).textContent || "-";
  const gradoText = (document.getElementById("sel-grado").selectedOptions[0] || {}).textContent || "-";

  const vals = Array.from(document.querySelectorAll("#stat-grid input")).map(i=>Number(i.value)||0);
  const specieId = document.getElementById("sel-specie").value;
  const classeId = document.getElementById("sel-classe").value;
  const specieRow = SPECIE.find(r=>r[0]==specieId) || [];
  const classeRow = CLASSI.find(r=>r[0]==classeId) || [];
  const sMods = getSpecieModsByRow(specieRow);
  const cMods = getClasseModsByRow(classeRow);

  let html = `<h3 style="margin:0 0 8px 0;color:var(--lego-blue)">${name}</h3>`;
  html += `<div style="display:flex;gap:12px;flex-wrap:wrap"><div style="min-width:180px"><b>Specie:</b> ${specieText}<br><b>Classe:</b> ${classeText}<br><b>Multiverso:</b> ${multiText}<br><b>Livello:</b> ${livText}<br><b>Grado:</b> ${gradoText}</div>`;
  html += `<div style="flex:1"><b>Statistiche</b><div style="margin-top:8px">`;
  statNames.forEach((n, i)=>{
    const base = Math.floor((vals[i]-10)/2);
    const tot = base + (Number(sMods[i]||0)) + (Number(cMods[i]||0));
    html += `<div style="display:flex;justify-content:space-between;padding:4px 0"><div>${n}</div><div>${vals[i]} (mod ${tot>=0? "+"+tot:tot})</div></div>`;
  });
  html += `</div></div></div>`;
  document.getElementById("preview").innerHTML = html;
}

/* ------------- PG list management ------------- */
function buildPGTable(){
  const thead = document.querySelector("#pg-table thead");
  const tbody = document.querySelector("#pg-table tbody");
  // headers: ID,NOME,ID_SPECIE,ID_CLASSE,ID_MULTIVERSO,ID_LIVELLO,ID_GRADO, {statNames...}
  const headers = ["ID","NOME","ID_SPECIE","ID_CLASSE","ID_MULTIVERSO","ID_LIVELLO","ID_GRADO",...statNames];
  thead.innerHTML = "<tr>" + headers.map(h=>`<th>${h}</th>`).join("") + "</tr>";
  tbody.innerHTML = "";
  // existing PGDB
  PGDB.forEach(r=>{
    const row = r.slice(0);
    while(row.length < headers.length) row.push("");
    tbody.innerHTML += "<tr>" + row.map(c=>`<td>${c}</td>`).join("") + "</tr>";
  });
  // nuovi
  NUOVI.forEach(r=>{
    const row = r.slice(0);
    while(row.length < headers.length) row.push("");
    tbody.innerHTML += "<tr>" + row.map(c=>`<td>${c}</td>`).join("") + "</tr>";
  });
}

/* ------------- add new PG ------------- */
function aggiungiPG(){
  const name = document.getElementById("name").value.trim();
  if(!name){ alert("Inserisci un nome per il personaggio"); return; }
  // compute next ID
  let last = 0;
  PGDB.forEach(r=>{ last = Math.max(last, Number(r[0]||0)); });
  NUOVI.forEach(r=>{ last = Math.max(last, Number(r[0]||0)); });
  const nid = last + 1;
  const specieId = document.getElementById("sel-specie").value || "";
  const classeId = document.getElementById("sel-classe").value || "";
  const multiId = document.getElementById("sel-multi").value || "";
  const livId = document.getElementById("sel-liv").value || "";
  const gradoId = document.getElementById("sel-grado").value || "";
  const vals = Array.from(document.querySelectorAll("#stat-grid input")).map(i=>String(Number(i.value)||0));
  const row = [String(nid), name, specieId, classeId, multiId, livId, gradoId, ...vals];
  NUOVI.push(row);
  buildPGTable();
  // reset name and stats
  document.getElementById("name").value = "";
  document.querySelectorAll("#stat-grid input").forEach(i=>i.value = 0);
  puntiUsati = 0;
  recalcAll();
  updatePreview();
}

/* ------------- download merged CSV ------------- */
function scaricaCSV(){
  // header
  const headers = ["ID","NOME","ID_SPECIE","ID_CLASSE","ID_MULTIVERSO","ID_LIVELLO","ID_GRADO",...statNames];
  const lines = [headers.join(";")];
  PGDB.forEach(r=>{
    const copy = r.slice(0);
    while(copy.length < headers.length) copy.push("");
    lines.push(copy.join(";"));
  });
  NUOVI.forEach(r=>{
    const copy = r.slice(0);
    while(copy.length < headers.length) copy.push("");
    lines.push(copy.join(";"));
  });
  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "pg-database.csv";
  a.click();
}

/* ------------- reset new ------------- */
function resetNuovi(){ if(confirm("Resettare i nuovi PG non salvati?")){ NUOVI = []; buildPGTable(); }}

/* ------------- attach events ------------- */
function attachLiveEvents(){
  // name change preview
  document.getElementById("name").addEventListener("input", updatePreview);
  // stat inputs already have change listener in renderStatInputs
  // also when selects change recalc
  ["sel-specie","sel-classe","sel-multi","sel-liv","sel-grado"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("change", () => { onGradeChangeIfNeeded(); recalcAll(); updatePreview(); });
  });
}

/* ------------- logout ------------- */
function logout(){ localStorage.removeItem("legoUser"); location.href="index.html"; }

/* ------------- start ------------- */
init();
</script>
</body>
</html>
