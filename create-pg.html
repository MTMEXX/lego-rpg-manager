<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LEGO RPG Manager - Crea Personaggio</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --lego-yellow: #f7d23e;
      --lego-red: #e53e3e;
      --lego-blue: #3182ce;
      --lego-gray: #f8f8f8;
    }

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: var(--lego-gray);
      color: #222;
    }

    header {
      background: var(--lego-yellow);
      padding: 20px;
      text-align: center;
      font-weight: 800;
      font-size: 1.8em;
      color: var(--lego-red);
      text-shadow: 2px 2px 0 #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    main {
      max-width: 1000px;
      margin: 30px auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    label { font-weight: 600; margin-top: 10px; display: block; }

    select, input[type="text"], input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .stat-row input { width: 70px; text-align: center; }

    button {
      background: var(--lego-blue);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
      margin-top: 15px;
    }
    button:hover { background: #4a9aff; }

    .bottom-buttons {
      text-align: center;
      margin: 30px 0;
    }

    .bottom-buttons button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1em;
      cursor: pointer;
      transition: 0.2s;
    }

    .logout { background: var(--lego-red); color: white; }
    .logout:hover { background: #ff5252; }
    .back { background: var(--lego-blue); color: white; }
    .back:hover { background: #4a9aff; }

    table { width: 100%; border-collapse: collapse; margin-top: 30px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: var(--lego-yellow); }
  </style>
</head>
<body>

<header>LEGO RPG Manager - Crea Personaggio</header>

<main>
  <h2>üß± Crea Nuovo Personaggio</h2>

  <label>Nome</label>
  <input type="text" id="pgNome" placeholder="Inserisci nome del personaggio">

  <label>Specie</label>
  <select id="pgSpecie"></select>

  <label>Classe</label>
  <select id="pgClasse"></select>

  <label>Multiverso</label>
  <select id="pgMultiverso"></select>

  <label>Livello</label>
  <select id="pgLivello"></select>

  <label>Grado</label>
  <select id="pgGrado" onchange="updatePuntiDisponibili()"></select>

  <p><strong>Punti disponibili:</strong> <span id="puntiRimanenti">0</span></p>

  <div id="statContainer"></div>

  <button onclick="creaPersonaggio()">‚ûï Crea Personaggio</button>

  <h3>üë• Personaggi Creati</h3>
  <table id="pgTable"></table>

  <button onclick="downloadCSV()">‚¨áÔ∏è Scarica CSV completo</button>
</main>

<div class="bottom-buttons">
  <button class="back" onclick="goTo('dashboard.html')">‚Üê Dashboard</button>
  <button class="logout" onclick="logout()">Logout</button>
</div>

<script>
const baseURL = "https://raw.githubusercontent.com/MTMEXX/lego-rpg-manager/refs/heads/main/db/";
let specie=[], classi=[], multiversi=[], livelli=[], gradi=[], stats=[], pgList=[];
let puntiTotali = 0;
let puntiUsati = 0;

// ‚úÖ Parser CSV migliorato
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  return lines.slice(1).map(line => {
    const match = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    return match ? match.map(v=>v.replace(/^"|"$/g,'')) : [];
  });
}

async function loadCSV(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error("Errore nel caricamento: "+url);
  const text = await res.text();
  return parseCSV(text);
}

async function init(){
  specie = await loadCSV(baseURL+"speci.csv");
  classi = await loadCSV(baseURL+"classi.csv");
  multiversi = await loadCSV(baseURL+"multiversi-pg.csv");
  livelli = await loadCSV(baseURL+"livelli.csv");
  gradi = await loadCSV(baseURL+"gradi.csv");
  stats = await loadCSV(baseURL+"statistiche_primarie.csv");
  pgList = await loadCSV(baseURL+"pg-database.csv");

  fillSelect("pgSpecie", specie);
  fillSelect("pgClasse", classi);
  fillSelect("pgMultiverso", multiversi);
  fillSelect("pgLivello", livelli);
  fillSelect("pgGrado", gradi);

  renderStats();
  renderTable();
}

function fillSelect(id, data){
  const s=document.getElementById(id);
  s.innerHTML='<option value="">-- Seleziona --</option>';
  data.forEach(r=>{
    if(r[0] && r[1]) s.innerHTML+=`<option value="${r[0]}">${r[1]}</option>`;
  });
}

function renderStats(){
  const container=document.getElementById("statContainer");
  container.innerHTML="";
  stats.forEach(r=>{
    const name=r[1];
    if(!name) return;
    const div=document.createElement("div");
    div.classList.add("stat-row");
    div.innerHTML=`
      <label>${name}</label>
      <input type="number" min="0" value="0" onchange="aggiornaPunti()" data-stat="${name}">
    `;
    container.appendChild(div);
  });
}

function updatePuntiDisponibili(){
  const gradoID=document.getElementById("pgGrado").value;
  const grado=gradi.find(g=>g[0]===gradoID);
  puntiTotali=grado?parseInt(grado[3]||0):0;
  puntiUsati=0;
  document.getElementById("puntiRimanenti").textContent=puntiTotali;
  document.querySelectorAll('#statContainer input').forEach(i=>i.value=0);
}

function aggiornaPunti(){
  let tot=0;
  document.querySelectorAll('#statContainer input').forEach(i=>tot+=parseInt(i.value||0));
  if(tot>puntiTotali){
    alert("Hai superato i punti disponibili!");
    event.target.value=0;
    aggiornaPunti();
    return;
  }
  puntiUsati=tot;
  document.getElementById("puntiRimanenti").textContent=puntiTotali-puntiUsati;
}

function creaPersonaggio(){
  const nome=document.getElementById("pgNome").value.trim();
  if(!nome) return alert("Inserisci un nome!");
  const specieID=document.getElementById("pgSpecie").value;
  const classeID=document.getElementById("pgClasse").value;
  const multiID=document.getElementById("pgMultiverso").value;
  const lvlID=document.getElementById("pgLivello").value;
  const gradoID=document.getElementById("pgGrado").value;

  const id=pgList.length?parseInt(pgList[pgList.length-1][0])+1:1;
  const statsValues=[...document.querySelectorAll('#statContainer input')].map(i=>parseInt(i.value||0));

  const newPg=[id,nome,specieID,classeID,multiID,lvlID,gradoID,...statsValues];
  pgList.push(newPg);
  renderTable();
}

function renderTable(){
  const table=document.getElementById("pgTable");
  table.innerHTML="";
  if(pgList.length<1) return;
  const headers=["ID","Nome","Specie","Classe","Multiverso","Livello","Grado",...stats.map(s=>s[1])];
  let html="<tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr>";
  pgList.forEach(r=>{
    html+="<tr>"+r.map(c=>`<td>${c||""}</td>`).join("")+"</tr>";
  });
  table.innerHTML=html;
}

function downloadCSV(){
  const headers=["ID","NOME","ID_SPECIE","ID_CLASSE","ID_MULTIVERSO","ID_LIVELLO","ID_GRADO",...stats.map(s=>s[1])];
  const csv=[headers.join(",")].concat(pgList.map(r=>r.join(","))).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="pg-database.csv";
  a.click();
}

function logout(){ localStorage.removeItem("legoUser"); window.location.href="index.html"; }
function goTo(page){ window.location.href=page; }

init();
</script>
</body>
</html>
