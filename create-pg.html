<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crea Personaggio - LEGO RPG Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --lego-yellow: #f7d23e;
      --lego-red: #e53e3e;
      --lego-blue: #3182ce;
      --lego-gray: #f8f8f8;
    }

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: var(--lego-gray);
      color: #222;
    }

    header {
      background: var(--lego-yellow);
      padding: 20px;
      text-align: center;
      font-weight: 800;
      font-size: 1.8em;
      color: var(--lego-red);
      text-shadow: 2px 2px 0 #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      position: relative;
    }

    .logout, .back {
      position: absolute;
      top: 20px;
      background: var(--lego-blue);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }

    .back { left: 20px; }
    .logout { right: 20px; background: var(--lego-red); }

    main {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    h2 { color: var(--lego-blue); }

    label {
      font-weight: 600;
      margin-top: 15px;
      display: block;
    }

    select, input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }

    #modTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    #modTable th, #modTable td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }

    #createdPGs {
      margin-top: 30px;
    }

    .save-btn {
      margin-top: 25px;
      background: var(--lego-blue);
      color: white;
      border: none;
      padding: 12px 22px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
    }
  </style>
</head>

<body>

<header>
  Crea Personaggio
  <button class="back" onclick="window.location.href='dashboard.html'">‚Üê Dashboard</button>
  <button class="logout" onclick="logout()">Logout</button>
</header>

<main>
  <h2>Dati Base</h2>

  <label>Nome del personaggio</label>
  <input type="text" id="pgNome">

  <label>Specie</label>
  <select id="pgSpecie"></select>

  <label>Classe</label>
  <select id="pgClasse"></select>

  <label>Multiverso</label>
  <select id="pgMulti"></select>

  <label>Livello</label>
  <select id="pgLivello"></select>

  <label>Grado</label>
  <select id="pgGrado"></select>

  <h2>Statistiche Primarie</h2>
  <p>Punti disponibili: <b id="puntiRimanenti">0</b></p>
  <div id="statContainer"></div>

  <h2>Modificatori</h2>
  <table id="modTable">
    <tr><th>Stat</th><th>Mod Totale</th></tr>
  </table>

  <button class="save-btn" onclick="aggiungiPG()">Aggiungi PG</button>

  <div id="createdPGs">
    <h2>PG Creati</h2>
    <table id="pgTable">
      <tr><th>ID</th><th>Nome</th><th>Specie</th><th>Classe</th></tr>
    </table>
    <button class="save-btn" onclick="scaricaCSV()">Scarica CSV PG</button>
  </div>
</main>

<script>
const BASE = "https://raw.githubusercontent.com/MTMEXX/lego-rpg-manager/refs/heads/main/db/";

let specie = [], classi = [], multi = [], livelli = [], gradi = [], stats = [];
let puntiTotali = 0;
let puntiUsati = 0;
let pgCreati = [];

// --- CARICA CSV ---
async function loadCSV(url) {
  const res = await fetch(url);
  const txt = await res.text();
  return txt.split("\n").map(r => r.split(";"));
}

// --- INITIAL LOAD ---
(async function init() {
  specie = await loadCSV(BASE + "speci.csv");
  classi = await loadCSV(BASE + "classi.csv");
  livelli = await loadCSV(BASE + "livelli.csv");
  gradi = await loadCSV(BASE + "gradi.csv");
  multi = await loadCSV(BASE + "multiversi-pg.csv");
  stats = await loadCSV(BASE + "statistiche_primarie.csv");

  fillSelect("pgSpecie", specie);
  fillSelect("pgClasse", classi);
  fillSelect("pgLivello", livelli);
  fillSelect("pgGrado", gradi);
  fillSelect("pgMulti", multi);

  renderStats();
  updateModifiers();
})();

function fillSelect(id, arr) {
  const sel = document.getElementById(id);
  sel.innerHTML = "<option value=''>-- Seleziona --</option>";
  arr.forEach(r => {
    if (r[0] && r[1])
      sel.innerHTML += `<option value="${r[0]}">${r[1]}</option>`;
  });
}

// --- RENDER STAT PRIMARIE ---
function renderStats() {
  const container = document.getElementById("statContainer");
  container.innerHTML = "";
  const gradoID = document.getElementById("pgGrado").value;
  const gradoRow = gradi.find(g => g[0] === gradoID);
  puntiTotali = gradoRow ? parseInt(gradoRow[3]) : 0;
  
  document.getElementById("puntiRimanenti").textContent = puntiTotali;

  stats.forEach((s, idx) => {
    if (!s[1]) return;
    container.innerHTML += `
      <div class="stat-row">
        <span>${s[1]}</span>
        <input type="number" min="0" value="0" data-index="${idx}" onchange="aggiornaPunti()">
      </div>`;
  });
}

// --- AGGIORNA PUNTI ---
function aggiornaPunti() {
  let tot = 0;
  document.querySelectorAll("#statContainer input").forEach(i => {
    tot += parseInt(i.value || 0);
  });

  if (tot > puntiTotali) {
    alert("Hai superato i punti disponibili!");
    event.target.value = 0;
    aggiornaPunti();
    return;
  }

  puntiUsati = tot;
  document.getElementById("puntiRimanenti").textContent = puntiTotali - tot;
  updateModifiers();
}

// --- CALCOLO MODIFICATORI ---
function updateModifiers() {
  const modTable = document.getElementById("modTable");
  modTable.innerHTML = `<tr><th>Stat</th><th>Mod Totale</th></tr>`;

  const specieID = document.getElementById("pgSpecie").value;
  const classeID = document.getElementById("pgClasse").value;

  const rowSp = specie.find(s => s[0] === specieID);
  const rowCl = classi.find(c => c[0] === classeID);

  const modSp = rowSp ? rowSp.slice(5, 11).map(Number) : [0,0,0,0,0,0];
  const modCl = rowCl ? rowCl.slice(10, 16).map(Number) : [0,0,0,0,0,0];

  document.querySelectorAll("#statContainer input").forEach((input, idx) => {
    const val = parseInt(input.value || 0);
    const base = Math.floor((val - 10) / 2);
    const tot = base + modSp[idx] + modCl[idx];

    modTable.innerHTML += `
      <tr>
        <td>${stats[idx][1]}</td>
        <td>${tot >= 0 ? "+" + tot : tot}</td>
      </tr>`;
  });
}

// --- CREA PG ---
function aggiungiPG() {
  const nome = document.getElementById("pgNome").value;
  if (!nome) return alert("Inserisci un nome!");

  const id = pgCreati.length + 1;

  pgCreati.push({
    id,
    nome,
    specie: document.getElementById("pgSpecie").value,
    classe: document.getElementById("pgClasse").value
  });

  document.getElementById("pgTable").innerHTML += `
    <tr>
      <td>${id}</td>
      <td>${nome}</td>
      <td>${document.getElementById("pgSpecie").value}</td>
      <td>${document.getElementById("pgClasse").value}</td>
    </tr>
  `;
}

// --- DOWNLOAD CSV COMPLETO ---
function scaricaCSV() {
  let csv = "ID;NOME;SPECIE;CLASSE\n";
  pgCreati.forEach(pg => {
    csv += `${pg.id};${pg.nome};${pg.specie};${pg.classe}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "pg-database.csv";
  link.click();
}

function logout() {
  localStorage.removeItem("legoUser");
  window.location.href = "index.html";
}
</script>

</body>
</html>
